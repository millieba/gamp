// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema
// Based on main schema from https://authjs.dev/reference/adapter/prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Represents the definition of a badge that can be awarded to user accounts
model BadgeDefinition {
  id          String       @id
  name        String       @unique
  description String
  image       String
  points      Int
  type        String
  threshold   Int
  badgeAwards BadgeAward[] // One badge definition can be related to many badge awards

  @@map("badge_definitions")
}

// Represents the instance of a badge being earned by a user
model BadgeAward {
  id         String   @id @default(cuid())
  badgeId    String   @unique @map("badge_id")
  accountId  String   @map("account_id")
  dateEarned DateTime @map("date_earned")

  badgeDefinition BadgeDefinition @relation(fields: [badgeId], references: [id])
  account         Account         @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@map("badge_awards")
}

// One user can have multiple accounts with different providers.
model Account {
  id                       String       @id @default(cuid())
  userId                   String       @map("user_id")
  type                     String
  provider                 String
  providerAccountId        String       @map("provider_account_id")
  refresh_token            String?      @db.Text
  refresh_token_expires_in Int?
  access_token             String?      @db.Text
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String?      @db.Text
  session_state            String?
  githubStats              GitHubStats?
  badges                   BadgeAward[] // List of badges the user has been awarded with
  lastSync                 DateTime?    @map("last_sync") // Timestamp of last sync (for badges and stats)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime? @map("email_verified")
  image         String?
  accounts      Account[]
  sessions      Session[]

  @@map("users")
}

// Represents GitHub statistics for a user account
model GitHubStats {
  id                      String @id @default(cuid())
  accountId               String @unique @map("account_id")
  commitCount             Int?   @map("commit_count")
  repoCount               Int?   @map("repo_count")
  issueCount              Int?   @map("issue_count")
  avgTimeToCloseIssues    Int?   @map("avg_time_to_close_issues")
  closedIssueCount        Int?   @map("closed_issue_count")
  languagesCount          Int?   @map("languages_count")
  createdPrs              Int?   @map("created_prs")
  createdAndMergedPrs     Int?   @map("created_and_merged_prs")
  strictStreak            Int?   @map("strict_streak")
  strictStreakToContinue  Int?   @map("strict_streak_to_continue")
  workdayStreak           Int?   @map("workday_streak")
  workdayStreakToContinue Int?   @map("workday_streak_to_continue")

  programmingLanguages ProgrammingLanguage[]

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@map("github_stats")
}

// Represents programming languages used in GitHub statistics
model ProgrammingLanguage {
  id            String @id @default(cuid())
  name          String
  bytesWritten  Int    @map("bytes_written")
  githubStatsId String @map("github_stats_id")

  githubStats GitHubStats @relation(fields: [githubStatsId], references: [id], onDelete: Cascade)

  @@map("programming_languages")
}
